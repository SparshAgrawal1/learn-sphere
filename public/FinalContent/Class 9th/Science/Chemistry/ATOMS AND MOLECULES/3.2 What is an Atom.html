<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3.2 What is an Atom? - Interactive Chemistry</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0f0f23 0%, #1a1a40 25%, #2d2d5f 50%, #1a1a40 75%, #0f0f23 100%);
            color: white;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Animated Background */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                radial-gradient(2px 2px at 20% 30%, white, transparent),
                radial-gradient(2px 2px at 60% 70%, white, transparent),
                radial-gradient(1px 1px at 50% 50%, white, transparent);
            background-size: 200px 200px;
            opacity: 0.3;
            animation: drift 60s linear infinite;
            pointer-events: none;
        }

        @keyframes drift {
            from { transform: translate(0, 0); }
            to { transform: translate(-200px, -200px); }
        }

        /* Audio Control */
        #audio-control {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }

        .control-btn {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            border: none;
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.3);
        }

        .control-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 12px 30px rgba(59, 130, 246, 0.5);
        }

        .control-btn.muted .unmute-icon { display: none; }
        .control-btn:not(.muted) .mute-icon { display: none; }

        /* Main Container */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 30px 20px;
        }

        /* Header */
        .header {
            text-align: center;
            margin-bottom: 40px;
            position: relative;
        }

        .header h1 {
            font-size: 3.5rem;
            background: linear-gradient(45deg, #60a5fa, #a78bfa, #f472b6);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 15px;
            font-weight: 700;
            animation: glow 3s ease-in-out infinite;
        }

        @keyframes glow {
            0%, 100% { filter: brightness(1) drop-shadow(0 0 20px rgba(96, 165, 250, 0.5)); }
            50% { filter: brightness(1.2) drop-shadow(0 0 40px rgba(167, 139, 250, 0.7)); }
        }

        .header p {
            font-size: 1.3rem;
            opacity: 0.9;
            max-width: 800px;
            margin: 0 auto;
            line-height: 1.6;
        }

        /* Main Layout */
        .main-content {
            display: grid;
            grid-template-columns: 1fr;
            gap: 30px;
            margin-bottom: 40px;
        }

        /* Atomic Stage */
        .atomic-stage {
            background: linear-gradient(135deg, 
                rgba(15, 23, 42, 0.9) 0%,
                rgba(30, 41, 59, 0.9) 50%,
                rgba(15, 23, 42, 0.9) 100%);
            border-radius: 25px;
            height: 600px;
            position: relative;
            box-shadow: 
                0 25px 50px rgba(0, 0, 0, 0.5),
                inset 0 0 100px rgba(96, 165, 250, 0.1);
            overflow: hidden;
            border: 3px solid rgba(96, 165, 250, 0.3);
        }

        #atomCanvas {
            width: 100%;
            height: 100%;
            display: block;
            cursor: grab;
        }

        #atomCanvas:active {
            cursor: grabbing;
        }

        /* Stage Info */
        .stage-info {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 15px 20px;
            border: 2px solid rgba(96, 165, 250, 0.3);
            max-width: 350px;
        }

        .stage-info h3 {
            font-size: 1.2rem;
            color: #60a5fa;
            margin-bottom: 8px;
        }

        .stage-info p {
            font-size: 0.9rem;
            color: #e2e8f0;
            line-height: 1.4;
        }

        /* Element Display Box */
        .element-display-box {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(15px);
            border-radius: 15px;
            padding: 20px 30px;
            border: 2px solid rgba(96, 165, 250, 0.3);
            display: none;
            text-align: center;
            z-index: 10;
            min-width: 300px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        .element-display-box h2 {
            color: #60a5fa;
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .element-display-box .element-info {
            color: #e2e8f0;
            font-size: 1.1rem;
            margin: 5px 0;
        }

        .element-display-box .atomic-mass {
            color: #f472b6;
            font-size: 1.3rem;
            font-weight: bold;
        }

        /* Size Comparison Panel */
        .size-comparison {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 15px;
            border: 2px solid rgba(96, 165, 250, 0.3);
            width: 280px;
            max-height: 400px;
            overflow-y: auto;
            display: none;
            z-index: 10;
        }

        .size-comparison h4 {
            color: #60a5fa;
            margin-bottom: 10px;
            font-size: 1rem;
        }

        .size-item {
            display: flex;
            align-items: center;
            margin: 8px 0;
            padding: 5px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 5px;
        }

        .size-color {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-right: 10px;
        }

        .size-text {
            flex: 1;
            font-size: 0.85rem;
            color: #e2e8f0;
        }

        .size-value {
            font-size: 0.8rem;
            color: #a5b4fc;
        }

        /* Controls */
        .controls {
            text-align: center;
            margin: 40px 0;
        }

        .controls-title {
            font-size: 2rem;
            margin-bottom: 25px;
            background: linear-gradient(45deg, #60a5fa, #a78bfa);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: 600;
        }

        .demo-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
            margin: 25px 0;
        }

        .demo-btn {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            border: none;
            color: white;
            padding: 14px 24px;
            border-radius: 35px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.3);
            min-width: 160px;
            position: relative;
            overflow: hidden;
        }

        .demo-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .demo-btn:hover::before {
            left: 100%;
        }

        .demo-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 30px rgba(59, 130, 246, 0.4);
        }

        .demo-btn.active {
            background: linear-gradient(135deg, #10b981, #059669);
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.4);
            animation: activePulse 2s ease-in-out infinite;
        }

        .demo-btn {
            transition: all 0.2s ease;
        }

        .demo-btn:active {
            transform: translateY(0) scale(0.98);
        }

        /* Enhanced Button States */
        .demo-btn.loading {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            cursor: wait;
            opacity: 0.8;
            animation: loadingPulse 1.5s ease-in-out infinite;
        }

        .demo-btn.loading::after {
            content: '...';
            animation: loadingDots 1.5s infinite;
        }

        .demo-btn.disabled {
            background: linear-gradient(135deg, #6b7280, #4b5563);
            cursor: not-allowed;
            opacity: 0.6;
            transform: none;
            box-shadow: 0 4px 15px rgba(107, 114, 128, 0.3);
        }

        .demo-btn.disabled:hover {
            transform: none;
            box-shadow: 0 4px 15px rgba(107, 114, 128, 0.3);
        }

        /* Loading animations */
        @keyframes loadingPulse {
            0%, 100% { 
                box-shadow: 0 8px 25px rgba(245, 158, 11, 0.4);
            }
            50% { 
                box-shadow: 0 8px 25px rgba(245, 158, 11, 0.7);
            }
        }

        @keyframes loadingDots {
            0%, 20% { content: ''; }
            40% { content: '.'; }
            60% { content: '..'; }
            80%, 100% { content: '...'; }
        }

        /* Interruption feedback */
        .demo-btn.interrupting {
            animation: interruptFlash 0.5s ease-in-out;
        }

        @keyframes interruptFlash {
            0% { 
                background: linear-gradient(135deg, #ef4444, #dc2626);
                transform: scale(1);
            }
            50% { 
                transform: scale(0.95);
            }
            100% { 
                transform: scale(1);
            }
        }

        @keyframes activePulse {
            0%, 100% { 
                box-shadow: 0 8px 25px rgba(16, 185, 129, 0.4);
            }
            50% { 
                box-shadow: 0 12px 35px rgba(16, 185, 129, 0.6);
            }
        }

        /* Info Panel */
        .info-panel {
            background: linear-gradient(135deg, 
                rgba(0, 0, 0, 0.6),
                rgba(30, 41, 59, 0.6));
            border-radius: 25px;
            padding: 35px;
            margin: 35px 0;
            border: 3px solid rgba(96, 165, 250, 0.3);
            backdrop-filter: blur(15px);
        }

        .info-panel h3 {
            font-size: 1.8rem;
            background: linear-gradient(45deg, #60a5fa, #a78bfa);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 20px;
        }

        .info-panel p {
            font-size: 1.1rem;
            line-height: 1.8;
            color: #e2e8f0;
            margin-bottom: 15px;
        }

        /* Elements Tables */
        .elements-table {
            margin-top: 30px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 20px;
        }

        .elements-table h4 {
            color: #60a5fa;
            margin-bottom: 15px;
            font-size: 1.3rem;
            text-align: center;
            background: linear-gradient(45deg, #60a5fa, #a78bfa);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .elements-table table {
            width: 100%;
            border-collapse: collapse;
        }

        .elements-table th {
            background: linear-gradient(135deg, rgba(96, 165, 250, 0.2), rgba(167, 139, 250, 0.2));
            padding: 12px;
            text-align: left;
            color: #a5b4fc;
            font-weight: 600;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .elements-table td {
            padding: 10px 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #e2e8f0;
        }

        .elements-table tr:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        /* Three column table */
        .symbols-table {
            margin-top: 30px;
        }

        .symbols-table table {
            width: 100%;
            table-layout: fixed;
        }

        .symbols-table td {
            width: 16.66%;
            text-align: center;
        }

        /* Questions Section */
        .questions-section {
            background: linear-gradient(135deg, 
                rgba(0, 0, 0, 0.6),
                rgba(30, 41, 59, 0.6));
            border-radius: 25px;
            padding: 35px;
            margin: 35px 0;
            border: 3px solid rgba(96, 165, 250, 0.3);
            backdrop-filter: blur(15px);
        }

        .question-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .question-item:hover {
            background: rgba(255, 255, 255, 0.08);
        }

        .question {
            color: #60a5fa;
            font-weight: 600;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }

        .answer {
            color: #e2e8f0;
            display: none;
            margin-top: 10px;
            padding-left: 20px;
            line-height: 1.6;
        }

        .answer.show {
            display: block;
        }

        /* Progress Indicator */
        .progress-indicator {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            border-radius: 30px;
            padding: 10px 20px;
            display: none;
            gap: 10px;
            z-index: 100;
        }

        .progress-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transition: all 0.3s ease;
            display: inline-block;
            margin: 0 5px;
        }

        .progress-dot.active {
            background: linear-gradient(135deg, #60a5fa, #a78bfa);
            transform: scale(1.3);
        }

        .progress-dot.completed {
            background: #10b981;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .header h1 {
                font-size: 2.5rem;
            }
            
            .atomic-stage {
                height: 400px;
            }
            
            .demo-buttons {
                flex-direction: column;
                align-items: center;
            }
            
            .size-comparison {
                position: relative;
                top: auto;
                right: auto;
                width: 100%;
                margin: 20px 0;
                display: none !important;
            }

            .element-display-box {
                position: relative;
                bottom: auto;
                left: auto;
                transform: none;
                margin: 20px 0;
                width: 100%;
            }

            .stage-info {
                position: relative;
                top: auto;
                left: auto;
                margin: 20px 0;
                width: 100%;
            }

            .symbols-table {
                font-size: 0.85rem;
            }

            .demo-btn {
                min-width: 200px;
                margin: 5px 0;
            }
        }

        @media (max-width: 480px) {
            .header h1 {
                font-size: 2rem;
            }
            
            .atomic-stage {
                height: 300px;
            }
            
            .demo-btn {
                min-width: 180px;
                padding: 12px 20px;
                font-size: 1rem;
            }
        }
    </style>
</head>
<body>
    <!-- Audio Control -->
    <div id="audio-control">
        <button id="mute-btn" class="control-btn">
            <span class="unmute-icon">üîä</span>
            <span class="mute-icon">üîá</span>
        </button>
    </div>

    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>3.2 What is an Atom?</h1>
            <p>Discover the building blocks of all matter - from their incredible size to their fundamental properties</p>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Atomic Stage -->
            <div class="atomic-stage" id="stage">
                <canvas id="atomCanvas"></canvas>
                
                <div class="stage-info" id="stageInfo">
                    <h3 id="infoTitle">Welcome to the Atomic World</h3>
                    <p id="infoText">Select a topic below to explore the fascinating world of atoms</p>
                </div>

                <div class="size-comparison" id="sizeComparison">
                    <h4>Relative Sizes (in meters)</h4>
                    <div id="sizeItems"></div>
                </div>

                <div class="element-display-box" id="elementDisplayBox">
                    <h2 id="displaySymbol">H</h2>
                    <div class="element-info" id="displayName">Hydrogen</div>
                    <div class="element-info">Atomic Number: <span id="displayAtomic">1</span></div>
                    <div class="atomic-mass">Atomic Mass: <span id="displayMass">1</span> u</div>
                </div>
            </div>
        </div>

        <!-- Controls -->
        <div class="controls">
            <div class="controls-title" id="lesson-title">Explore the World of Atoms</div>
            
            <div class="demo-buttons">
                <button class="demo-btn" id="btn-complete" onclick="handleButtonClick(playCompleteStory, 'btn-complete')">üìñ Complete Story</button>
                <button class="demo-btn" id="btn-atomic-radius" onclick="handleButtonClick(exploreAtomicRadius, 'btn-atomic-radius')">üìè Atomic Radius</button>
                <button class="demo-btn" id="btn-relative-sizes" onclick="handleButtonClick(showRelativeSizes, 'btn-relative-sizes')">üîç Relative Sizes</button>
                <button class="demo-btn" id="btn-surface" onclick="handleButtonClick(showSurfaceElements, 'btn-surface')">üî¨ Surface of Silicon</button>
                <button class="demo-btn" id="btn-atomic-mass" onclick="handleButtonClick(showAtomicMass, 'btn-atomic-mass')">‚öñÔ∏è Atomic Mass</button>
                <button class="demo-btn" id="btn-reset" onclick="handleButtonClick(resetAll, 'btn-reset')">üîÑ Reset</button>
            </div>
        </div>

        <!-- Info Panel -->
        <div class="info-panel">
            <h3>üìö Key Concepts</h3>
            <div id="panelContent">
                <p><strong>The Building Blocks of Matter:</strong> Atoms are the fundamental units of all matter in the universe. They are incredibly small - smaller than anything we can imagine or compare with in our everyday experience.</p>
                
                <p><strong>Atomic Radius:</strong> The size of atoms is measured in nanometres (nm). One nanometre is 1/10‚Åπ meters - that's one billionth of a meter!</p>
                
                <p><strong>Atomic Mass:</strong> Each element has a characteristic atomic mass, measured in atomic mass units (u), where 1 u equals 1/12 the mass of a carbon-12 atom.</p>
            </div>

            <!-- Table 3.1: Symbols for some elements -->
            <div class="elements-table symbols-table">
                <h4>Table 3.1: Symbols for some elements</h4>
                <table>
                    <thead>
                        <tr>
                            <th>Element</th>
                            <th>Symbol</th>
                            <th>Element</th>
                            <th>Symbol</th>
                            <th>Element</th>
                            <th>Symbol</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Aluminium</td>
                            <td>Al</td>
                            <td>Copper</td>
                            <td>Cu</td>
                            <td>Nitrogen</td>
                            <td>N</td>
                        </tr>
                        <tr>
                            <td>Argon</td>
                            <td>Ar</td>
                            <td>Fluorine</td>
                            <td>F</td>
                            <td>Oxygen</td>
                            <td>O</td>
                        </tr>
                        <tr>
                            <td>Barium</td>
                            <td>Ba</td>
                            <td>Gold</td>
                            <td>Au</td>
                            <td>Potassium</td>
                            <td>K</td>
                        </tr>
                        <tr>
                            <td>Boron</td>
                            <td>B</td>
                            <td>Hydrogen</td>
                            <td>H</td>
                            <td>Silicon</td>
                            <td>Si</td>
                        </tr>
                        <tr>
                            <td>Bromine</td>
                            <td>Br</td>
                            <td>Iodine</td>
                            <td>I</td>
                            <td>Silver</td>
                            <td>Ag</td>
                        </tr>
                        <tr>
                            <td>Calcium</td>
                            <td>Ca</td>
                            <td>Iron</td>
                            <td>Fe</td>
                            <td>Sodium</td>
                            <td>Na</td>
                        </tr>
                        <tr>
                            <td>Carbon</td>
                            <td>C</td>
                            <td>Lead</td>
                            <td>Pb</td>
                            <td>Sulphur</td>
                            <td>S</td>
                        </tr>
                        <tr>
                            <td>Chlorine</td>
                            <td>Cl</td>
                            <td>Magnesium</td>
                            <td>Mg</td>
                            <td>Uranium</td>
                            <td>U</td>
                        </tr>
                        <tr>
                            <td>Cobalt</td>
                            <td>Co</td>
                            <td>Neon</td>
                            <td>Ne</td>
                            <td>Zinc</td>
                            <td>Zn</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Table 3.2: Atomic masses of a few elements -->
            <div class="elements-table">
                <h4>Table 3.2: Atomic masses of a few elements</h4>
                <table>
                    <thead>
                        <tr>
                            <th>Element</th>
                            <th>Atomic Mass (u)</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Hydrogen</td>
                            <td>1</td>
                        </tr>
                        <tr>
                            <td>Carbon</td>
                            <td>12</td>
                        </tr>
                        <tr>
                            <td>Nitrogen</td>
                            <td>14</td>
                        </tr>
                        <tr>
                            <td>Oxygen</td>
                            <td>16</td>
                        </tr>
                        <tr>
                            <td>Sodium</td>
                            <td>23</td>
                        </tr>
                        <tr>
                            <td>Magnesium</td>
                            <td>24</td>
                        </tr>
                        <tr>
                            <td>Sulphur</td>
                            <td>32</td>
                        </tr>
                        <tr>
                            <td>Chlorine</td>
                            <td>35.5</td>
                        </tr>
                        <tr>
                            <td>Calcium</td>
                            <td>40</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Questions Section -->
        <div class="questions-section">
            <h3 style="font-size: 1.8rem; background: linear-gradient(45deg, #60a5fa, #a78bfa); background-clip: text; -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 20px;">Test Your Understanding</h3>
            
            <div class="question-item" onclick="toggleAnswer(1)">
                <div class="question">1. Define the atomic mass unit.</div>
                <div class="answer" id="answer1">
                    An atomic mass unit (u) is a mass unit equal to exactly one-twelfth (1/12) the mass of one atom of carbon-12. This standard was chosen in 1961 as a universal reference for measuring atomic masses.
                </div>
            </div>
            
            <div class="question-item" onclick="toggleAnswer(2)">
                <div class="question">2. Why is it not possible to see an atom with naked eyes?</div>
                <div class="answer" id="answer2">
                    Atoms are extremely small - typically around 10‚Åª¬π‚Å∞ meters in diameter. This is far smaller than the wavelength of visible light (400-700 nm), which means light cannot resolve individual atoms. Our eyes can only see objects that are at least about 0.1 mm in size, which is about a million times larger than an atom!
                </div>
            </div>
        </div>

        <!-- Progress Indicator -->
        <div class="progress-indicator" id="progressIndicator">
            <div class="progress-dot" data-step="1"></div>
            <div class="progress-dot" data-step="2"></div>
            <div class="progress-dot" data-step="3"></div>
            <div class="progress-dot" data-step="4"></div>
            <div class="progress-dot" data-step="5"></div>
            <div class="progress-dot" data-step="6"></div>
        </div>
    </div>

    <script>
        // Narrator System
        class AtomicNarrator {
            constructor() {
                this.isEnabled = globalAudioEnabled && this.isSpeechSynthesisAvailable();
                this.currentUtterance = null;
                this.settings = { rate: 0.9, pitch: 1.0, volume: 0.85 };
                this.isDestroyed = false;
                this.isSpeaking = false;
                this.activeTimeouts = [];
                
                if (!this.isEnabled) {
                    console.warn('Speech synthesis not available, narration disabled');
                }
            }

            // Check if speech synthesis is available
            isSpeechSynthesisAvailable() {
                return 'speechSynthesis' in window && 'SpeechSynthesisUtterance' in window;
            }

            async speak(text, delay = 0) {
                if (!this.isEnabled || !text || this.isDestroyed) return Promise.resolve();
                
                return new Promise((resolve) => {
                    const timeoutId = setTimeout(() => {
                        if (this.isDestroyed) {
                            resolve();
                            return;
                        }
                        
                        this.stop();
                        
                        // Ensure speech synthesis is ready
                        if (speechSynthesis.speaking) {
                            speechSynthesis.cancel();
                        }
                        
                        const utterance = new SpeechSynthesisUtterance(text);
                        Object.assign(utterance, this.settings);
                        
                        this.isSpeaking = true;
                        let resolved = false;
                        
                        const cleanup = () => {
                            if (!resolved) {
                                resolved = true;
                                this.isSpeaking = false;
                                this.currentUtterance = null;
                                resolve();
                            }
                        };
                        
                        utterance.onend = cleanup;
                        utterance.onerror = (event) => {
                            console.warn('Speech synthesis error:', event.error);
                            cleanup();
                        };
                        
                        utterance.onstart = () => {
                            // Ensure only one utterance is active
                            if (this.currentUtterance !== utterance) {
                                speechSynthesis.cancel();
                                return;
                            }
                        };
                        
                        this.currentUtterance = utterance;
                        
                        try {
                            speechSynthesis.speak(utterance);
                        } catch (error) {
                            console.error('Failed to speak:', error);
                            cleanup();
                        }
                    }, delay);
                    
                    // Store timeout for cleanup
                    if (this.activeTimeouts) {
                        this.activeTimeouts.push(timeoutId);
                    }
                });
            }

            stop() {
                this.isSpeaking = false;
                try {
                    speechSynthesis.cancel();
                } catch (error) {
                    console.warn('Error stopping speech synthesis:', error);
                }
                this.currentUtterance = null;
            }

            destroy() {
                this.isDestroyed = true;
                this.stop();
                this.currentUtterance = null;
                this.settings = null;
                
                // Clear any pending timeouts
                if (this.activeTimeouts) {
                    this.activeTimeouts.forEach(timeoutId => clearTimeout(timeoutId));
                    this.activeTimeouts = [];
                }
            }
        }

        // Enhanced Global State Management
        let globalAudioEnabled = true;
        let narrator = null;
        let isAnimating = false;
        let currentActiveButton = null;
        let animationCancelled = false;
        let activeTimeouts = [];
        let activeIntervals = [];
        
        // Debouncing and Click Management
        let lastButtonClick = 0;
        let buttonClickDelay = 500; // Increased delay for smoother operation
        let buttonStates = new Map(); // Track button states
        let currentAnimationPromise = null;
        let currentAnimation = null;
        
        // Button State Constants
        const BUTTON_STATES = {
            IDLE: 'idle',
            LOADING: 'loading',
            ACTIVE: 'active',
            DISABLED: 'disabled'
        };

        // Enhanced Animation Manager Class
        class AnimationManager {
            constructor() {
                this.isRunning = false;
                this.currentButton = null;
                this.cancelled = false;
                this.activeTimeouts = [];
                this.activeIntervals = [];
                this.narrator = null;
                this.currentAnimation = null;
            }

            // Start a new animation, stopping any existing one
            async startAnimation(buttonId, animationFunction) {
                // Debounce rapid clicks
                if (!this.canStartAnimation()) {
                    console.log(`üö´ Animation blocked - debouncing active`);
                    return;
                }

                console.log(`üé¨ Starting animation for button: ${buttonId}`);
                
                // Stop any existing animation
                await this.stopAnimation();
                
                // Set up new animation
                this.isRunning = true;
                this.currentButton = buttonId;
                this.currentAnimation = buttonId;
                this.cancelled = false;
                
                // Create new narrator with timeout tracking
                this.narrator = new AtomicNarrator();
                this.narrator.activeTimeouts = this.activeTimeouts;
                
                // Update button state
                this.setButtonState(buttonId, BUTTON_STATES.ACTIVE);
                this.setButtonState(buttonId, BUTTON_STATES.LOADING);
                
                try {
                    // Execute the animation function
                    this.currentAnimationPromise = animationFunction();
                    await this.currentAnimationPromise;
                } catch (error) {
                    console.error(`Animation error for ${buttonId}:`, error);
                } finally {
                    // Always cleanup
                    this.finishAnimation();
                }
            }

            // Check if animation can start (debouncing)
            canStartAnimation() {
                const now = Date.now();
                if (now - lastButtonClick < buttonClickDelay) {
                    return false;
                }
                lastButtonClick = now;
                return true;
            }

            // Stop current animation
            async stopAnimation() {
                console.log(`üõë Stopping animation...`);
                
                this.cancelled = true;
                this.isRunning = false;
                
                // Stop narrator first
                if (this.narrator && !this.narrator.isDestroyed) {
                    this.narrator.stop();
                    this.narrator.destroy();
                }
                this.narrator = null;
                
                // Clear timeouts and intervals
                this.clearAllTimeouts();
                
                // Clear scene
                clearScene();
                
                // Reset UI
                this.resetUI();
                
                // Reset button states
                this.resetAllButtonStates();
                
                // Wait for cleanup to complete
                await this.wait(200);
                
                console.log(`‚úÖ Animation stopped`);
            }

            // Finish animation (called in finally block)
            finishAnimation() {
                this.isRunning = false;
                this.currentButton = null;
                this.currentAnimation = null;
                this.currentAnimationPromise = null;
                
                // Cleanup narrator
                if (this.narrator && !this.narrator.isDestroyed) {
                    this.narrator.destroy();
                }
                this.narrator = null;
                
                // Clear timeouts
                this.clearAllTimeouts();
                
                // Reset button states with safe timeout
                this.safeSetTimeout(() => {
                    this.resetAllButtonStates();
                }, 500);
            }

            // Set button state with visual feedback
            setButtonState(buttonId, state) {
                const button = document.getElementById(buttonId);
                if (!button) return;

                // Remove existing state classes
                button.classList.remove('loading', 'active', 'disabled');
                
                switch (state) {
                    case BUTTON_STATES.LOADING:
                        button.classList.add('loading');
                        button.disabled = true;
                        break;
                    case BUTTON_STATES.ACTIVE:
                        button.classList.add('active');
                        button.disabled = false;
                        break;
                    case BUTTON_STATES.DISABLED:
                        button.classList.add('disabled');
                        button.disabled = true;
                        break;
                    default:
                        button.disabled = false;
                }
                
                buttonStates.set(buttonId, state);
            }

            // Reset all button states
            resetAllButtonStates() {
                document.querySelectorAll('.demo-btn').forEach(btn => {
                    btn.classList.remove('loading', 'active', 'disabled');
                    btn.disabled = false;
                    buttonStates.set(btn.id, BUTTON_STATES.IDLE);
                });
                currentActiveButton = null;
            }

            // Reset UI elements
            resetUI() {
                hideProgress();
                document.getElementById('sizeComparison').style.display = 'none';
                document.getElementById('elementDisplayBox').style.display = 'none';
            }

            // Clear all timeouts and intervals
            clearAllTimeouts() {
                this.activeTimeouts.forEach(timeoutId => clearTimeout(timeoutId));
                this.activeIntervals.forEach(intervalId => clearInterval(intervalId));
                this.activeTimeouts = [];
                this.activeIntervals = [];
            }

            // Safe setTimeout
            safeSetTimeout(callback, delay) {
                const timeoutId = setTimeout(() => {
                    try {
                        callback();
                    } catch (error) {
                        console.error('Timeout callback error:', error);
                    } finally {
                        // Remove from active list when executed
                        const index = this.activeTimeouts.indexOf(timeoutId);
                        if (index > -1) {
                            this.activeTimeouts.splice(index, 1);
                        }
                    }
                }, delay);
                this.activeTimeouts.push(timeoutId);
                return timeoutId;
            }

            // Safe setInterval
            safeSetInterval(callback, delay) {
                const intervalId = setInterval(callback, delay);
                this.activeIntervals.push(intervalId);
                return intervalId;
            }

            // Check if animation should continue
            shouldContinue() {
                return !this.cancelled && this.isRunning;
            }

            // Wait with cancellation support
            async wait(ms) {
                return new Promise(resolve => {
                    if (!this.shouldContinue()) {
                        resolve();
                        return;
                    }
                    
                    const timeoutId = this.safeSetTimeout(() => {
                        if (this.shouldContinue()) {
                            resolve();
                        }
                    }, ms);
                    
                    // Store timeout ID for potential cancellation
                    this.activeTimeouts.push(timeoutId);
                });
            }

            // Speak with cancellation support
            async speak(text) {
                if (!this.shouldContinue() || !this.narrator || this.narrator.isDestroyed) return;
                
                try {
                    await this.narrator.speak(text);
                } catch (error) {
                    console.error('Narration error:', error);
                    // Continue execution even if narration fails
                }
            }
        }

        // Create global animation manager instance
        const animationManager = new AnimationManager();

        // Three.js variables
        let scene, camera, renderer;
        let atomModel, siliconSurface;
        let particles = [];
        let animationId;
        let sizeComparison = [];

        // Elements Data
        const elements = [
            { symbol: 'H', name: 'Hydrogen', atomicNumber: 1, atomicMass: 1, color: 0xff6b6b },
            { symbol: 'C', name: 'Carbon', atomicNumber: 6, atomicMass: 12, color: 0x4a4a4a },
            { symbol: 'N', name: 'Nitrogen', atomicNumber: 7, atomicMass: 14, color: 0x0066ff },
            { symbol: 'O', name: 'Oxygen', atomicNumber: 8, atomicMass: 16, color: 0xff0000 },
            { symbol: 'Na', name: 'Sodium', atomicNumber: 11, atomicMass: 23, color: 0xffff00 },
            { symbol: 'Mg', name: 'Magnesium', atomicNumber: 12, atomicMass: 24, color: 0x00ff00 },
            { symbol: 'S', name: 'Sulphur', atomicNumber: 16, atomicMass: 32, color: 0xffff66 },
            { symbol: 'Cl', name: 'Chlorine', atomicNumber: 17, atomicMass: 35.5, color: 0x00ff00 },
            { symbol: 'Ca', name: 'Calcium', atomicNumber: 20, atomicMass: 40, color: 0xdddddd }
        ];

        const sizesData = [
            { name: 'Atom of hydrogen', size: '10‚Åª¬π‚Å∞', color: '#ff6b6b', scale: 0.1 },
            { name: 'Molecule of water', size: '10‚Åª‚Åπ', color: '#3b82f6', scale: 0.2 },
            { name: 'Molecule of haemoglobin', size: '10‚Åª‚Å∏', color: '#ef4444', scale: 0.4 },
            { name: 'Grain of sand', size: '10‚Åª‚Å¥', color: '#fbbf24', scale: 0.8 },
            { name: 'Ant', size: '10‚Åª¬≥', color: '#8b5cf6', scale: 1.2 },
            { name: 'Apple', size: '10‚Åª¬π', color: '#10b981', scale: 2.0 }
        ];

        // Button management
        function setActiveButton(buttonId) {
            document.querySelectorAll('.demo-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            if (buttonId) {
                const btn = document.getElementById(buttonId);
                if (btn) {
                    btn.classList.add('active');
                    currentActiveButton = buttonId;
                }
            }
        }

        // Legacy function - now handled by AnimationManager
        function stopAllAnimations() {
            animationManager.stopAnimation();
        }

        // Initialize Three.js
        function initThreeJS() {
            const canvas = document.getElementById('atomCanvas');
            const container = document.getElementById('stage');
            
            scene = new THREE.Scene();
            scene.background = null;
            
            const width = container.clientWidth;
            const height = container.clientHeight;
            camera = new THREE.PerspectiveCamera(60, width / height, 0.1, 1000);
            camera.position.set(0, 5, 20);
            camera.lookAt(0, 0, 0);
            
            renderer = new THREE.WebGLRenderer({ 
                canvas: canvas, 
                antialias: true,
                alpha: true 
            });
            renderer.setSize(width, height);
            
            // Lighting
            const ambientLight = new THREE.AmbientLight(0x404040, 0.8);
            scene.add(ambientLight);
            
            const directionalLight = new THREE.DirectionalLight(0xffffff, 1);
            directionalLight.position.set(10, 10, 5);
            scene.add(directionalLight);
            
            const pointLight = new THREE.PointLight(0xffffff, 0.5);
            pointLight.position.set(-10, -10, -5);
            scene.add(pointLight);
            
            // Create initial atom
            createBasicAtom('H');
            
            // Setup controls
            setupMouseControls();
            
            // Start animation loop
            animate();
        }

        // Create basic atom model
        function createBasicAtom(elementSymbol, animated = false, showMassInfo = false) {
            clearScene();
            
            const element = elements.find(e => e.symbol === elementSymbol);
            if (!element) return;
            
            atomModel = new THREE.Group();
            
            // Nucleus
            const nucleusGeometry = new THREE.SphereGeometry(1, 32, 32);
            const nucleusMaterial = new THREE.MeshPhongMaterial({
                color: 0xff0000,
                emissive: 0xff0000,
                emissiveIntensity: 0.4
            });
            const nucleus = new THREE.Mesh(nucleusGeometry, nucleusMaterial);
            atomModel.add(nucleus);
            
            // Add protons and neutrons texture
            for (let i = 0; i < element.atomicNumber; i++) {
                const protonGeometry = new THREE.SphereGeometry(0.2, 16, 16);
                const protonMaterial = new THREE.MeshPhongMaterial({
                    color: 0xff4444,
                    emissive: 0xff4444,
                    emissiveIntensity: 0.3
                });
                const proton = new THREE.Mesh(protonGeometry, protonMaterial);
                
                const phi = Math.acos(1 - 2 * (i + 0.5) / element.atomicNumber);
                const theta = Math.PI * (1 + Math.sqrt(5)) * i;
                
                proton.position.x = 0.7 * Math.sin(phi) * Math.cos(theta);
                proton.position.y = 0.7 * Math.sin(phi) * Math.sin(theta);
                proton.position.z = 0.7 * Math.cos(phi);
                
                atomModel.add(proton);
            }
            
            // Electron shells
            const shellConfig = getElectronShellConfig(element.atomicNumber);
            let electronIndex = 0;
            
            shellConfig.forEach((electronsInShell, shellIndex) => {
                const shellRadius = 2 + shellIndex * 1.5;
                
                // Shell ring
                const ringGeometry = new THREE.TorusGeometry(shellRadius, 0.05, 8, 64);
                const ringMaterial = new THREE.MeshBasicMaterial({
                    color: 0x60a5fa,
                    opacity: 0.3,
                    transparent: true
                });
                const ring = new THREE.Mesh(ringGeometry, ringMaterial);
                ring.rotation.x = Math.PI / 2;
                atomModel.add(ring);
                
                // Add electrons
                for (let i = 0; i < electronsInShell; i++) {
                    const electronGeometry = new THREE.SphereGeometry(0.15, 16, 16);
                    const electronMaterial = new THREE.MeshPhongMaterial({
                        color: 0x3b82f6,
                        emissive: 0x3b82f6,
                        emissiveIntensity: 0.5
                    });
                    const electron = new THREE.Mesh(electronGeometry, electronMaterial);
                    
                    const angle = (i / electronsInShell) * Math.PI * 2;
                    
                    electron.userData = {
                        radius: shellRadius,
                        angle: angle,
                        speed: 1 - shellIndex * 0.2
                    };
                    
                    electron.position.x = Math.cos(angle) * shellRadius;
                    electron.position.z = Math.sin(angle) * shellRadius;
                    
                    atomModel.add(electron);
                    particles.push(electron);
                    
                    if (animated) {
                        electron.scale.set(0, 0, 0);
                        animateParticleAppear(electron, electronIndex * 50 + 500);
                    }
                    
                    electronIndex++;
                }
            });
            
            scene.add(atomModel);
            
            // Show element info box if needed
            if (showMassInfo) {
                const displayBox = document.getElementById('elementDisplayBox');
                displayBox.style.display = 'block';
                document.getElementById('displaySymbol').textContent = element.symbol;
                document.getElementById('displayName').textContent = element.name;
                document.getElementById('displayAtomic').textContent = element.atomicNumber;
                document.getElementById('displayMass').textContent = element.atomicMass;
            }
        }

        // Create size comparison spheres
        function createSizeComparisonSpheres() {
            clearScene();
            
            sizeComparison = new THREE.Group();
            
            sizesData.forEach((item, index) => {
                const geometry = new THREE.SphereGeometry(item.scale, 32, 32);
                const material = new THREE.MeshPhongMaterial({
                    color: item.color,
                    transparent: true,
                    opacity: 0.8,
                    emissive: item.color,
                    emissiveIntensity: 0.3
                });
                const sphere = new THREE.Mesh(geometry, material);
                
                const xPos = (index - 2.5) * 3;
                sphere.position.x = xPos;
                sphere.position.y = 0;
                
                sphere.userData = item;
                sizeComparison.add(sphere);
            });
            
            scene.add(sizeComparison);
            
            // Update size comparison panel
            const sizeComparisonEl = document.getElementById('sizeComparison');
            sizeComparisonEl.style.display = 'block';
            
            const sizeItemsEl = document.getElementById('sizeItems');
            sizeItemsEl.innerHTML = sizesData.map(item => `
                <div class="size-item">
                    <div class="size-color" style="background: ${item.color}"></div>
                    <div class="size-text">${item.name}</div>
                    <div class="size-value">${item.size} m</div>
                </div>
            `).join('');
        }

        // Create silicon surface
        function createSiliconSurface() {
            clearScene();
            
            siliconSurface = new THREE.Group();
            
            const rows = 10;
            const cols = 10;
            const spacing = 1.5;
            
            for (let i = 0; i < rows; i++) {
                for (let j = 0; j < cols; j++) {
                    const geometry = new THREE.SphereGeometry(0.4, 32, 32);
                    const material = new THREE.MeshPhongMaterial({
                        color: 0x888888,
                        emissive: 0x444444,
                        emissiveIntensity: 0.2,
                        metalness: 0.8,
                        roughness: 0.2
                    });
                    const atom = new THREE.Mesh(geometry, material);
                    
                    atom.position.x = (i - rows/2) * spacing;
                    atom.position.z = (j - cols/2) * spacing;
                    atom.position.y = Math.sin(i * 0.5) * 0.2 + Math.cos(j * 0.5) * 0.2;
                    
                    atom.userData = {
                        originalY: atom.position.y,
                        phase: Math.random() * Math.PI * 2,
                        amplitude: 0.1 + Math.random() * 0.1
                    };
                    
                    siliconSurface.add(atom);
                    particles.push(atom);
                }
            }
            
            siliconSurface.rotation.x = -0.3;
            scene.add(siliconSurface);
        }

        // Get electron shell configuration
        function getElectronShellConfig(electronCount) {
            const shells = [];
            let remaining = electronCount;
            const maxPerShell = [2, 8, 8, 18];
            
            for (let i = 0; i < maxPerShell.length && remaining > 0; i++) {
                const electronsInShell = Math.min(remaining, maxPerShell[i]);
                shells.push(electronsInShell);
                remaining -= electronsInShell;
            }
            
            return shells;
        }

        // Animate particle appearance
        function animateParticleAppear(particle, delay) {
            safeSetTimeout(() => {
                let scale = 0;
                const interval = safeSetInterval(() => {
                    scale += 0.1;
                    if (scale >= 1) {
                        scale = 1;
                        clearInterval(interval);
                        // Remove from active intervals list
                        const index = activeIntervals.indexOf(interval);
                        if (index > -1) {
                            activeIntervals.splice(index, 1);
                        }
                    }
                    particle.scale.set(scale, scale, scale);
                }, 20);
            }, delay);
        }

        // Clear scene
        function clearScene() {
            while(scene.children.length > 3) { // Keep lights
                const child = scene.children[3];
                scene.remove(child);
                if(child.geometry) child.geometry.dispose();
                if(child.material) {
                    if(Array.isArray(child.material)) {
                        child.material.forEach(m => m.dispose());
                    } else {
                        child.material.dispose();
                    }
                }
            }
            particles = [];
            atomModel = null;
            siliconSurface = null;
            sizeComparison = null;
        }

        // Legacy timeout functions - now handled by AnimationManager
        function clearAllTimeouts() {
            animationManager.clearAllTimeouts();
        }

        function safeSetTimeout(callback, delay) {
            return animationManager.safeSetTimeout(callback, delay);
        }

        function safeSetInterval(callback, delay) {
            return animationManager.safeSetInterval(callback, delay);
        }

        // Enhanced button click handler with AnimationManager
        async function handleButtonClick(buttonFunction, buttonId) {
            console.log(`üñ±Ô∏è Button clicked: ${buttonId}`);
            
            // Show immediate visual feedback
            const button = document.getElementById(buttonId);
            if (button) {
                button.style.transform = 'translateY(0) scale(0.98)';
                setTimeout(() => {
                    button.style.transform = '';
                }, 150);
            }
            
            // Force cleanup of any previous content to prevent overlap
            console.log("üßπ Forcing cleanup to prevent content overlap...");
            
            // Show brief cleanup indicator
            updateStageInfo("üîÑ Switching...", "Clearing previous content");
            
            // Stop any running animations immediately
            await animationManager.stopAnimation();
            
            // Clear scene and UI elements
            clearScene();
            document.getElementById('sizeComparison').style.display = 'none';
            document.getElementById('elementDisplayBox').style.display = 'none';
            hideProgress();
            
            // Brief pause to ensure cleanup is complete
            await new Promise(resolve => setTimeout(resolve, 100));
            
            console.log("‚úÖ Cleanup completed, starting new animation");
            
            // Start animation using the AnimationManager
            await animationManager.startAnimation(buttonId, buttonFunction);
        }

        // Complete Story - Refactored with AnimationManager
        async function playCompleteStory() {
            showProgress();
            updateTitle("üìñ The Complete Story of Atoms");
            
            // Chapter 1: Introduction
            updateProgress(1);
            updateStageInfo("Chapter 1: Introduction", "The building blocks of matter");
            createBasicAtom('H', true);
            
            await animationManager.speak("The building blocks of all matter are atoms. How big are atoms? Atoms are very small, they are smaller than anything that we can imagine or compare with.");
            
            if (!animationManager.shouldContinue()) return;
            await animationManager.wait(2000);
            
            // Chapter 2: Atomic Radius
            updateProgress(2);
            updateStageInfo("Chapter 2: Atomic Radius", "Measuring the incredibly small");
            
            await animationManager.speak("Atomic radius is measured in nanometres. One nanometre equals one billionth of a meter.");
            
            if (!animationManager.shouldContinue()) return;
            await animationManager.wait(2000);
            
            // Chapter 3: Relative Sizes
            updateProgress(3);
            updateStageInfo("Chapter 3: Relative Sizes", "From atoms to everyday objects");
            createSizeComparisonSpheres();
            
            await animationManager.speak("Let's compare sizes. A hydrogen atom is 10 to the power minus 10 meters. An apple is a billion times larger!");
            
            if (!animationManager.shouldContinue()) return;
            await animationManager.wait(3000);
            document.getElementById('sizeComparison').style.display = 'none';
            
            // Chapter 4: Silicon Surface
            updateProgress(4);
            updateStageInfo("Chapter 4: Surface of Elements", "Modern imaging reveals atomic surfaces");
            createSiliconSurface();
            
            await animationManager.speak("Modern techniques allow us to see surfaces of elements at the atomic level, like this silicon surface.");
            
            if (!animationManager.shouldContinue()) return;
            await animationManager.wait(3000);
            
            // Chapter 5: Atomic Mass Details
            updateProgress(5);
            updateStageInfo("Chapter 5: Atomic Mass", "Understanding atomic mass units");
            
            await animationManager.speak("Now let's explore atomic masses. Each element has a characteristic atomic mass, measured in atomic mass units.");
            
            if (!animationManager.shouldContinue()) return;
            await animationManager.wait(2000);
            
            // Show atomic mass gallery with detailed information
            updateStageInfo("Chapter 5: Atomic Mass", "From lightest to heaviest elements");
            
            const elementsToShow = ['H', 'C', 'N', 'O', 'Na', 'Mg', 'S', 'Cl', 'Ca'];
            
            for (const symbol of elementsToShow) {
                if (!animationManager.shouldContinue()) return;
                
                const element = elements.find(e => e.symbol === symbol);
                createBasicAtom(symbol, true, true);
                
                // Update panel with detailed atomic mass information
                const relativeMassText = element.atomicMass === 1 ? 'Lightest element' : 
                                        element.atomicMass === 12 ? 'Standard reference' : 
                                        element.atomicMass === 40 ? 'Heaviest in our series' : 
                                        `${(element.atomicMass/12).toFixed(2)}x heavier than carbon-12`;
                
                updatePanelContent(`
                    <p><strong>${element.name} (${element.symbol})</strong></p>
                    <p>Atomic Number: ${element.atomicNumber}</p>
                    <p>Atomic Mass: ${element.atomicMass} u</p>
                    <p>Relative Mass: ${relativeMassText}</p>
                `);
                
                const massDescription = element.atomicMass === 1 ? 'the lightest element' : 
                                       element.atomicMass === 12 ? 'the standard reference for atomic mass' : 
                                       element.atomicMass === 40 ? 'one of the heavier elements we\'re exploring' : 
                                       `${(element.atomicMass/12).toFixed(2)} times heavier than carbon-12`;
                
                await animationManager.speak(`${element.name} has an atomic mass of ${element.atomicMass} atomic mass units. This makes it ${massDescription}.`);
                
                if (!animationManager.shouldContinue()) return;
                await animationManager.wait(2000);
            }
            
            if (!animationManager.shouldContinue()) return;
            document.getElementById('elementDisplayBox').style.display = 'none';
            
            // Atomic mass comparison
            updateStageInfo("Chapter 5: Atomic Mass", "Comparing atomic masses");
            updatePanelContent(`
                <p><strong>Atomic Mass Comparison:</strong></p>
                <ul>
                    <li>Hydrogen (1 u) vs Carbon (12 u) = 1:12 ratio</li>
                    <li>Carbon (12 u) vs Oxygen (16 u) = 3:4 ratio</li>
                    <li>Hydrogen (1 u) vs Calcium (40 u) = 1:40 ratio</li>
                </ul>
                <p>These mass ratios are crucial for understanding chemical formulas and reactions!</p>
            `);
            
            await animationManager.speak(`Notice the mass ratios between elements. For example, calcium is 40 times heavier than hydrogen, while oxygen is only ${(16/12).toFixed(2)} times heavier than carbon. These ratios are fundamental to chemistry!`);
            
            if (!animationManager.shouldContinue()) return;
            await animationManager.wait(3000);
            
            // Chapter 6: Understanding Atoms
            updateProgress(6);
            updateStageInfo("Chapter 6: Complete Picture", "Mass, size, and structure combined");
            createBasicAtom('O', true);
            
            await animationManager.speak("Each element has unique properties - its size, mass, and electron configuration make it special. Atomic mass helps us understand how elements combine in chemical reactions.");
            
            if (!animationManager.shouldContinue()) return;
            await animationManager.wait(3000);
            
            // Final summary
            updateStageInfo("Chapter 6: Complete Picture", "The full story of atoms");
            updatePanelContent(`
                <p><strong>Atomic Mass Summary:</strong></p>
                <ul>
                    <li>Hydrogen (H): 1 u - The lightest element</li>
                    <li>Carbon (C): 12 u - The standard reference</li>
                    <li>Oxygen (O): 16 u - Essential for life</li>
                    <li>Sodium (Na): 23 u - Common in salts</li>
                    <li>Calcium (Ca): 40 u - The heaviest we explored</li>
                </ul>
                <p>Atomic mass is measured in atomic mass units (u), where 1 u = 1/12 the mass of carbon-12.</p>
            `);
            
            await animationManager.speak("This completes our journey through the atomic world - from size to mass, from individual atoms to their incredible diversity!");
        }

        // Explore Atomic Radius - Refactored with AnimationManager
        async function exploreAtomicRadius() {
            try {
                updateTitle("üìè Exploring Atomic Radius");
                updateStageInfo("Atomic Radius", "Understanding atomic size measurements");
                
                createBasicAtom('H', true);
                await animationManager.speak("The atomic radius of hydrogen is approximately 10 to the power minus 10 meters.");
                
                if (!animationManager.shouldContinue()) return;
                await animationManager.wait(2000);
                
                if (!animationManager.shouldContinue()) return;
                createBasicAtom('C', true);
                await animationManager.speak("Carbon atoms are slightly larger than hydrogen. Remember, one nanometre equals 10 to the power minus 9 meters.");
                
                if (!animationManager.shouldContinue()) return;
                updatePanelContent("Atomic radius is the distance from the nucleus to the outermost electron shell. It's measured in picometres (pm) or angstroms (√Ö), where 1 √Ö = 10‚Åª¬π‚Å∞ meters.");
            } catch (error) {
                console.error("Error in exploreAtomicRadius:", error);
            }
        }

        // Show Relative Sizes - Refactored with AnimationManager
        async function showRelativeSizes() {
            try {
                updateTitle("üîç Relative Sizes");
                updateStageInfo("Size Comparison", "From atoms to everyday objects");
                
                createSizeComparisonSpheres();
                
                await animationManager.speak("Let's visualize the incredible range of sizes from atoms to everyday objects. Each sphere represents a different scale of matter.");
                
                if (!animationManager.shouldContinue()) return;
                await animationManager.wait(2000);
                
                if (!animationManager.shouldContinue()) return;
                await animationManager.speak("From hydrogen atoms at 10 to the minus 10 meters to an apple at 10 to the minus 1 meters - that's a billion-fold difference!");
            } catch (error) {
                console.error("Error in showRelativeSizes:", error);
            }
        }

        // Show Surface Elements - Refactored with AnimationManager
        async function showSurfaceElements() {
            try {
                updateTitle("üî¨ Surface of Silicon");
                updateStageInfo("Silicon Surface", "Atomic-level imaging");
                
                createSiliconSurface();
                
                await animationManager.speak("Modern scanning tunneling microscopes can image individual atoms on surfaces. Here we see silicon atoms arranged in a crystal lattice.");
                
                if (!animationManager.shouldContinue()) return;
                await animationManager.wait(3000);
                
                if (!animationManager.shouldContinue()) return;
                await animationManager.speak("Notice how the atoms vibrate slightly. This thermal motion is always present at temperatures above absolute zero.");
            } catch (error) {
                console.error("Error in showSurfaceElements:", error);
            }
        }

        // Show Atomic Mass Gallery - Refactored with AnimationManager
        async function showAtomicMass() {
            try {
                updateTitle("‚öñÔ∏è Atomic Mass Gallery");
                updateStageInfo("Element Showcase", "Exploring atomic masses from Hydrogen to Calcium");
                
                const elementsToShow = ['H', 'C', 'N', 'O', 'Na', 'Mg', 'S', 'Cl', 'Ca'];
                
                for (const symbol of elementsToShow) {
                    if (!animationManager.shouldContinue()) return;
                    
                    const element = elements.find(e => e.symbol === symbol);
                    createBasicAtom(symbol, true, true);
                    
                    await animationManager.speak(`${element.name}: Atomic number ${element.atomicNumber}, Atomic mass ${element.atomicMass} units.`);
                    
                    if (!animationManager.shouldContinue()) return;
                    await animationManager.wait(2500);
                }
                
                if (!animationManager.shouldContinue()) return;
                document.getElementById('elementDisplayBox').style.display = 'none';
                
                updatePanelContent("Each element has a unique atomic mass. Hydrogen is the lightest at 1 u, while calcium is 40 times heavier. These masses help us understand chemical reactions and compound formation.");
            } catch (error) {
                console.error("Error in showAtomicMass:", error);
            }
        }

        // Helper Functions
        function toggleAnswer(questionNum) {
            const answer = document.getElementById(`answer${questionNum}`);
            answer.classList.toggle('show');
        }

        async function resetAll() {
            console.log("üîÑ Resetting all...");
            
            // Use AnimationManager to stop any running animations
            await animationManager.stopAnimation();
            
            // Additional cleanup
            clearScene();
            document.getElementById('sizeComparison').style.display = 'none';
            document.getElementById('elementDisplayBox').style.display = 'none';
            hideProgress();
            
            // Wait for cleanup to complete
            await wait(300);
            
            // Reset to default state
            createBasicAtom('H', false);
            updateTitle("Explore the World of Atoms");
            updateStageInfo("Welcome to the Atomic World", "Select a topic below to explore the fascinating world of atoms");
            updatePanelContent(`
                <p><strong>The Building Blocks of Matter:</strong> Atoms are the fundamental units of all matter in the universe. They are incredibly small - smaller than anything we can imagine or compare with in our everyday experience.</p>
                
                <p><strong>Atomic Radius:</strong> The size of atoms is measured in nanometres (nm). One nanometre is 1/10‚Åπ meters - that's one billionth of a meter!</p>
                
                <p><strong>Atomic Mass:</strong> Each element has a characteristic atomic mass, measured in atomic mass units (u), where 1 u equals 1/12 the mass of a carbon-12 atom.</p>
            `);
            
            console.log("‚úÖ Reset completed");
        }

        function updateTitle(title) {
            document.getElementById('lesson-title').textContent = title;
        }

        function updateStageInfo(title, text) {
            document.getElementById('infoTitle').textContent = title;
            document.getElementById('infoText').textContent = text;
        }

        function updatePanelContent(html) {
            document.getElementById('panelContent').innerHTML = html;
        }

        function showProgress() {
            document.getElementById('progressIndicator').style.display = 'flex';
        }

        function hideProgress() {
            document.getElementById('progressIndicator').style.display = 'none';
        }

        function updateProgress(step) {
            document.querySelectorAll('.progress-dot').forEach((dot, index) => {
                if (index < step) {
                    dot.classList.add('completed');
                    dot.classList.remove('active');
                } else if (index === step - 1) {
                    dot.classList.add('active');
                } else {
                    dot.classList.remove('active', 'completed');
                }
            });
        }

        function wait(ms) {
            return animationManager.wait(ms);
        }

        // Setup mouse controls
        function setupMouseControls() {
            const canvas = renderer.domElement;
            let isDragging = false;
            let previousMousePosition = { x: 0, y: 0 };
            
            canvas.addEventListener('mousedown', (e) => {
                isDragging = true;
                previousMousePosition = { x: e.clientX, y: e.clientY };
            });
            
            canvas.addEventListener('mouseup', () => {
                isDragging = false;
            });
            
            canvas.addEventListener('mousemove', (e) => {
                if (!isDragging) return;
                
                const deltaX = e.clientX - previousMousePosition.x;
                const deltaY = e.clientY - previousMousePosition.y;
                
                const rotateObject = (obj) => {
                    if (obj) {
                        obj.rotation.y += deltaX * 0.01;
                        obj.rotation.x += deltaY * 0.01;
                    }
                };
                
                rotateObject(atomModel);
                rotateObject(siliconSurface);
                rotateObject(sizeComparison);
                
                previousMousePosition = { x: e.clientX, y: e.clientY };
            });
            
            canvas.addEventListener('wheel', (e) => {
                e.preventDefault();
                camera.position.z += e.deltaY * 0.01;
                camera.position.z = Math.max(10, Math.min(40, camera.position.z));
            });
        }

        // Animation loop
        function animate() {
            animationId = requestAnimationFrame(animate);
            
            // Animate electrons
            if (atomModel && particles.length > 0) {
                particles.forEach(electron => {
                    if (electron.userData.radius) {
                        const time = Date.now() * 0.001;
                        const angle = electron.userData.angle + time * electron.userData.speed;
                        electron.position.x = Math.cos(angle) * electron.userData.radius;
                        electron.position.z = Math.sin(angle) * electron.userData.radius;
                    }
                });
                
                if (!isDragging) {
                    atomModel.rotation.y += 0.003;
                }
            }
            
            // Animate silicon surface
            if (siliconSurface && particles.length > 0) {
                particles.forEach(atom => {
                    if (atom.userData.originalY !== undefined) {
                        const time = Date.now() * 0.001;
                        atom.position.y = atom.userData.originalY + 
                            Math.sin(time * 2 + atom.userData.phase) * atom.userData.amplitude;
                    }
                });
                
                if (!isDragging) {
                    siliconSurface.rotation.y += 0.002;
                }
            }
            
            // Animate size comparison
            if (sizeComparison) {
                sizeComparison.children.forEach((sphere, index) => {
                    const time = Date.now() * 0.001;
                    sphere.position.y = Math.sin(time + index * 0.5) * 0.3;
                });
                
                if (!isDragging) {
                    sizeComparison.rotation.y += 0.002;
                }
            }
            
            renderer.render(scene, camera);
        }

        let isDragging = false;

        // Audio Control
        document.getElementById('mute-btn').addEventListener('click', () => {
            globalAudioEnabled = !globalAudioEnabled;
            document.getElementById('mute-btn').classList.toggle('muted', !globalAudioEnabled);
            
            if (narrator) {
                narrator.isEnabled = globalAudioEnabled;
                if (!globalAudioEnabled) {
                    narrator.stop();
                }
            }
        });

        // Enhanced cleanup function
        async function cleanup() {
            console.log("üßπ Performing enhanced cleanup...");
            
            // Stop all animations using AnimationManager
            await animationManager.stopAnimation();
            
            // Stop animation loop
            if (animationId) {
                cancelAnimationFrame(animationId);
                animationId = null;
            }
            
            // Clean up Three.js resources
            if (renderer) {
                renderer.dispose();
                renderer = null;
            }
            
            // Clear scene completely
            if (scene) {
                clearScene();
            }
            
            // Reset all global states
            isAnimating = false;
            currentActiveButton = null;
            currentAnimation = null;
            
            console.log("‚úÖ Enhanced cleanup completed");
        }

        // Enhanced debug function to monitor system status
        function debugSystemStatus() {
            console.log("=== ENHANCED SYSTEM STATUS ===");
            console.log("AnimationManager Running:", animationManager.isRunning);
            console.log("Current Button:", animationManager.currentButton);
            console.log("Animation Cancelled:", animationManager.cancelled);
            console.log("Active Timeouts:", animationManager.activeTimeouts.length);
            console.log("Active Intervals:", animationManager.activeIntervals.length);
            console.log("Button States:", Object.fromEntries(buttonStates));
            console.log("Scene Children:", scene ? scene.children.length : "No scene");
            console.log("Particles Count:", particles.length);
            console.log("Narrator Active:", animationManager.narrator ? "Yes" : "No");
            console.log("Last Button Click:", new Date(lastButtonClick));
            console.log("===============================");
        }

        // Make debug function available globally
        window.debugSystem = debugSystemStatus;

        // Initialize
        window.addEventListener('DOMContentLoaded', () => {
            initThreeJS();
            narrator = new AtomicNarrator();
            narrator.speak("Welcome to the world of atoms! Discover the building blocks of all matter. Select a topic to begin your journey into the atomic realm!");
            
            // Show enhanced functionality status
            console.log("üöÄ ENHANCED BUTTON FUNCTIONALITY IMPLEMENTED!");
            console.log("‚úÖ Debouncing prevents rapid button clicks");
            console.log("‚úÖ Visual feedback shows button states (loading/active/disabled)");
            console.log("‚úÖ No animation stacking or glitches");
            console.log("‚úÖ Robust AnimationManager handles all operations");
            console.log("‚úÖ Smooth user experience with proper state management");
            console.log("‚úÖ Content overlap prevention - automatic cleanup between button clicks");
            console.log("üîß Debug: Run debugSystem() to monitor status");
        });

        // Cleanup on page unload
        window.addEventListener('beforeunload', cleanup);

        // Handle window resize
        window.addEventListener('resize', () => {
            const container = document.getElementById('stage');
            if (camera && renderer) {
                camera.aspect = container.clientWidth / container.clientHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(container.clientWidth, container.clientHeight);
            }
        });
    </script>
</body>
</html>